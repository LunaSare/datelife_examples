---
title: "DateLife Workflows"
author: "Luna L. Sanchez Reyes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
geometry: "left=3cm,right=3cm,top=2.5cm,bottom=4cm"
vignette: >
  %\VignetteIndexEntry{DateLife Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
my_table_format <- function(tt){
  res <- format.data.frame(tt, digits = 4, nsmall = 4, justify = "none")
  return(res)
}
library(microbenchmark)
loadd(taxon)
loadd(tax_dq)
loadd(tax_dr)
loadd(tax_summ)
loadd(tax_phyloall)
loadd(tax_phylomedian)
loadd(tax_sdm)
loadd(tax_datedotol)
loadd(tax_otol)
loadd(tax_treefromtax)
figcap1 <- paste0(taxon, " Species Dated Open Tree of Life Induced Subtree. This chronogram was obtained with `get_dated_otol_induced_subtree()` function.")
figcap2 <- paste0(taxon, " Species Tree from Taxonomy. This tree was obtained with `tree_from_taxonomy()` function.")
```

# Taxon `r taxon`
\raggedright
There are `r length(tax_dq$cleaned_names)` species in the Open Tree of Life Taxonomy for the taxon `r taxon`.
Information on time of divergence is available for
```{r echo = FALSE, results = 'asis'}
tt <- nrow(tax_phylomedian$taxon_distribution)
if(tt == length(tax_dq$cleaned_names)){
  cat("all")
} else {
  cat(nrow(tax_phylomedian$taxon_distribution))
}
```
of these species across `r length(tax_phyloall)` published and peer-reviewed chronograms from the following studies:

```{r echo = FALSE, results = 'asis', warning=FALSE}
citations <- as.matrix(unique(names(tax_phyloall)))
# print(kable(citations, caption = NULL, row.names = FALSE, booktabs = T))
for (i in seq(nrow(citations))){
  cat(paste0("**", i, ". ", citations[i,], "**\n\n"))
}
```

Species are distributed across chronograms as follows:
```{r echo=FALSE, message = FALSE, results = 'asis'}
# distributions <- tax_phylomedian$taxon_distribution
# print(knitr::kable(distributions, caption = NULL, row.names = FALSE,
#                    booktabs = T, col.names = colnames(distributions),
#                    align = "c"))
# the table does not look good, so map the percentage to a tree
# title1 = paste0(taxon, " Species Presence across chronograms in DateLife Data Base")
# make_plot_global(tax_datedotol, title1, taxon, tax_summ)
treesall <- list(tax_treefromtax$phy, tax_otol, tax_datedotol, tax_phylomedian$phy, tax_sdm)
resolved_nodes <- sapply(seq(treesall), function(i) treesall[[i]]$Nnode/ape::Ntip(treesall[[i]]))*100
resolved_nodes[resolved_nodes < 0] <- 0
table1 <- data.frame(Trees = c("Tree from NCBI Taxonomy", "Open Tree of Life Subtree", "Dated Open Tree of Life Subtree", "Median Summary Chronogram", "SDM Summary Chronogram"), Tips = sapply(treesall, ape::Ntip),
Resolved = paste0(round(resolved_nodes), "%"))
# table1 <- my_table_format(table1)
knitr::kable(table1, caption = "A table", row.names = FALSE, format = "markdown")
# %>%
#           row_spec(0, color = c(rep("white", 3), rep("black", 5)))
```

```{r myfile-1-plot, echo = F, results = 'asis', fig.cap= ""}
# knitr::include_graphics(paste0("docs/datedotol_", taxon, ".pdf"))
if(!inherits(tax_datedotol, "phylo")){
  plot1 <- paste0("Dated induced subtree could not be obtained for the ", taxon, ".\n")
} else {
  plot1 <- paste0("\n![", figcap1, "](", taxon, "_datedotol.pdf)\n")
}
cat(plot1)
```

# Summary
```{r echo = FALSE, results = 'asis'}
absent <- levels(tax_phylomedian$absent_taxa$taxon)
if(!"None" %in% absent){
  cat("The following species were completely absent from the chronogram data base: ", paste0("*", levels(tax_phylomedian$absent_taxa$taxon), collapse = "*, *", "*"))
}
```
